<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Funds (iPhone)</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #4682B4;
  margin: 0;
  padding: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* --- Countdown Tiles Section --- */
.countdown-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 18px;
  width: 100%;
  max-width: 800px;
  margin: 10px auto 30px;
}

.tile {
  background: linear-gradient(145deg, #ffffff, #e3f2fd);
  border-radius: 15px;
  padding: 15px;
  text-align: center;
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
  transition: transform 0.2s, box-shadow 0.2s;
  display: block;
}
.tile:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 28px rgba(0,0,0,0.2);
}
a.tile {
  text-decoration: none;
  color: inherit;
}
a.tile:visited {
  color: inherit;
}
.tile .label {
  font-weight: bold;
  font-size: 17px;
  margin-bottom: 8px;
  color: #000;
}
.tile .countdownText {
  font-size: 15px;
  font-weight: 600;
  color: #3101ab;
  margin-top: 6px;
}
.tile .date-range,
.tile .cycleText {
  font-size: 12px;
  color: #000;
  margin-top: 4px;
}

/* --- Dot Grid --- */
.dot-bar {
  display: grid;
  grid-template-columns: repeat(10, 10px);
  gap: 3px;
  justify-content: center;
  margin-top: 10px;
}
.dot {
  width: 10px;
  height: 10px;
  border-radius: 2px;
  background: #ccc;
  transition: background 0.5s ease;
}
.dot.green { background: #2ecc71; }
.dot.orange { background: #ff9800; }
.dot.red { background: #e53935; }

.separator {
  width: 100%;
  max-width: 800px;
  text-align: center;
  margin: 25px 0 15px;
  position: relative;
}
.separator::before, .separator::after {
  content: "";
  position: absolute;
  top: 50%;
  width: 35%;
  height: 2px;
  background: #ccc;
}
.separator::before { left: 0; }
.separator::after { right: 0; }
.separator span {
  padding: 0 10px;
  font-size: 18px;
  font-weight: bold;
  color: #080808;
  background: #f4f4f9;
  position: relative;
  z-index: 1;
}
</style>
</head>
<body>

<h2 style="color:white;margin-bottom:10px;">Upcoming Events</h2>
<div id="specialCountdowns" class="countdown-grid"></div>

<script>
function fmtDate(d) {
  return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: '2-digit' });
}
function daysBetween(a, b) {
  return Math.round((b - a) / 86400000);
}

const specialItems = [
  { name: "SAIL <br> Rental Income", type: "monthly", day: 1, link: "https://docs.google.com/spreadsheets/d/1G985V27a1ZgdyhMgLRXrlAw6LuelfWeSVIYb-LWpZYw" },
  { name: "SG REITS <br> Dividend Income", type: "quarterly", months: [2,5,8,11], day: -1, link: "https://docs.google.com/spreadsheets/d/1AcqXREzpG3ZUJRDsyQAPhNPYrZZ0ZN68qjH9h1USdXc" },
  { name: "GODSPED <br> Dividend Income", type: "quarterly", months: [2,5,8,11], day: -1, link: "https://docs.google.com/spreadsheets/d/1qxhyjXMm-rFkP24akt-VI4NP9tX4wvRLTTxgCZQHuwI" },
  { name: "$PUTS <br> Trading & Premium", type: "nthWeekday", weekday: 5, nth: 3, link: "https://docs.google.com/spreadsheets/d/1M13JlDcU-y_4tGblzshoSoK7B2B3KMZC1elC1ApDem8" },
  { name: "SAIL <br> Tenancy Status", type: "tenancy", start: {year:2024, month:1, day:1}, years:2, link: "https://docs.google.com/spreadsheets/d/1G985V27a1ZgdyhMgLRXrlAw6LuelfWeSVIYb-LWpZYw"  },
  { name: "LIFE <br> Dividend Capital", type: "semiannual", dates: [{month:5, day:15}, {month:11, day:15}], link: "https://docs.google.com/spreadsheets/d/1Lp8FHudrVeuiIhPqqYJvn6aoqj4obHIPb1LVZsTiCaU"  },
  { name: "FaR <br> Volatility Overlay", type: "season", start: {month:9, day:1}, end: {month:6, day:15}, link: "https://docs.google.com/spreadsheets/d/1PZebfDw5_7qkuLb-toSVXtHnIKLf2qdAit2KT5PLPv4"  }
];

function getNextDate(i) {
  const n = new Date();
  let x;

  switch(i.type) {
    case "monthly":
      x = new Date(n.getFullYear(), n.getMonth(), i.day);
      if (n >= x) x.setMonth(x.getMonth() + 1);
      break;
    case "quarterly":
      let found = false;
      for (let m of i.months) {
        let d = i.day === -1 ? new Date(n.getFullYear(), m + 1, 0) : new Date(n.getFullYear(), m, i.day);
        if (d > n) { x = d; found = true; break; }
      }
      if (!found)
        x = i.day === -1
          ? new Date(n.getFullYear() + 1, i.months[0] + 1, 0)
          : new Date(n.getFullYear() + 1, i.months[0], i.day);
      break;
    case "nthWeekday":
      let y = n.getFullYear(), mo = n.getMonth(), d = new Date(y, mo, 1), c = 0;
      while (d.getMonth() === mo) {
        if (d.getDay() === i.weekday) c++;
        if (c === i.nth && d > n) { x = new Date(d); break; }
        d.setDate(d.getDate() + 1);
      }
      if (!x) {
        mo++;
        d = new Date(y, mo, 1); c = 0;
        while (d.getMonth() === mo) {
          if (d.getDay() === i.weekday) c++;
          if (c === i.nth) { x = new Date(d); break; }
          d.setDate(d.getDate() + 1);
        }
      }
      break;
    case "tenancy":
      const startDate = new Date(i.start.year, i.start.month, i.start.day);
      const endDate = new Date(startDate);
      endDate.setFullYear(startDate.getFullYear() + i.years);
      if (n < endDate) x = endDate; else { endDate.setFullYear(endDate.getFullYear() + i.years); x = endDate; }
      break;
    case "semiannual":
      let c2 = null;
      for (let d2 of i.dates) {
        let dt = new Date(n.getFullYear(), d2.month, d2.day);
        if (dt > n && (!c2 || dt < c2)) c2 = dt;
      }
      if (!c2) c2 = new Date(n.getFullYear() + 1, i.dates[0].month, i.dates[0].day);
      x = c2;
      break;
    case "season": {
      const year = n.getFullYear();
      const nextYear = year + 1;
      const isSpecialYear = (nextYear - 2022) % 4 === 0;
      let periodStart, periodEnd;
      if (isSpecialYear) {
        const octStart = new Date(year, 9, 1);
        const janNext = new Date(nextYear, 0, 1);
        if (n >= octStart && n < janNext) {
          periodStart = octStart; periodEnd = janNext;
        } else {
          const janStart = new Date(year, 0, 1);
          const nextOct = new Date(year, 9, 1);
          periodStart = janStart; periodEnd = nextOct;
        }
      } else {
        const octStart = new Date(year, 9, 1);
        if (n < octStart) {
          periodStart = new Date(year - 1, 9, 1);
          periodEnd = new Date(year, 6, 15);
        } else {
          periodStart = octStart;
          periodEnd = new Date(nextYear, 6, 15);
        }
      }
      x = periodEnd;
      break;
    }
  }
  return x;
}

function getPrevDate(i, nx) {
  const p = new Date(nx);
  switch(i.type) {
    case "monthly": p.setMonth(p.getMonth() - 1); break;
    case "quarterly": p.setMonth(p.getMonth() - 3); break;
    case "nthWeekday": p.setMonth(p.getMonth() - 1); break;
    case "tenancy": p.setFullYear(p.getFullYear() - i.years); break;
    case "semiannual": p.setMonth(p.getMonth() - 6); break;
    case "season": p.setFullYear(p.getFullYear() - 1); break;
  }
  return p;
}

const cdContainer = document.getElementById("specialCountdowns");

// create tile elements
specialItems.forEach(i => {
  const d = document.createElement("a");
  d.className = "tile";
  d.href = i.link || "#";
  d.target = "_blank";
  d.innerHTML = `
    <div class="label">${i.name}</div>
    <div class="dot-bar"></div>
    <div class="countdownText">Loading...</div>
    <div class="date-range">...</div>
    <div class="cycleText">...</div>
  `;
  cdContainer.appendChild(d);
  i._el = d;
});

// --- SORTED countdown update ---
function updateCountdowns() {
  const n = new Date();
  const list = [];

  specialItems.forEach(i => {
    const nx = getNextDate(i), pv = getPrevDate(i, nx);
    const totalDays = daysBetween(pv, nx);
    let remaining = daysBetween(n, nx);
    if (remaining < 0) remaining = 0;
    list.push({ item: i, nx, pv, totalDays, remaining });
  });

  list.sort((a, b) => a.remaining - b.remaining);
  cdContainer.innerHTML = "";

  list.forEach(obj => {
    const i = obj.item;
    const { nx, pv, totalDays, remaining } = obj;
    const d = i._el;

    const maxDots = 100;
    const dotCount = Math.min(totalDays, maxDots);
    let remainingDots = remaining > maxDots ? maxDots : remaining;
    const bar = d.querySelector(".dot-bar");
    bar.innerHTML = "";
    for (let x = 0; x < dotCount; x++) {
      const dot = document.createElement("div");
      dot.className = "dot";
      if (x < remainingDots) {
        if (remainingDots <= 10) dot.classList.add("red");
        else if (remainingDots <= 30) dot.classList.add("orange");
        else dot.classList.add("green");
      }
      bar.appendChild(dot);
    }

    const ds = Math.floor(Math.max(0, (nx - n) / 86400000));
    d.querySelector(".countdownText").textContent = `ETA: ${ds > 0 ? ds + " days" : "Due soon"}`;
    d.querySelector(".date-range").textContent = `${fmtDate(pv)} â†’ ${fmtDate(nx)}`;
    d.querySelector(".cycleText").textContent = `Period: ${daysBetween(pv, nx)} days`;

    cdContainer.appendChild(d);
  });
}

updateCountdowns();
setInterval(updateCountdowns, 600000);
</script>
</body>
</html>
